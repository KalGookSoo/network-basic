# Chapter 03 네트워크 계층

## 03-1 LAN을 넘어서는 네트워크 계층

### 개요
이 섹션에서는 데이터 링크 계층의 한계를 넘어 서로 다른 네트워크를 연결하는 네트워크 계층에 대해 살펴봅니다. 인터넷 프로토콜(IP)의 기본 개념과 구조, IP 주소 체계, IPv4와 IPv6의 특징, 그리고 MAC 주소와 IP 주소를 매핑하는 ARP 프로토콜에 대해 학습합니다. 이를 통해 인터넷과 같은 대규모 네트워크가 어떻게 구성되고 동작하는지 이해하고, 네트워크 간 통신의 기본 원리를 습득합니다.

### 데이터 링크 계층의 한계
데이터 링크 계층은 같은 네트워크 내에서 장치 간 통신을 가능하게 하지만, 다음과 같은 한계가 있습니다:

1. **제한된 통신 범위**: 데이터 링크 계층은 동일한 네트워크(LAN) 내의 장치 간 통신만 지원합니다. MAC 주소는 로컬 네트워크 내에서만 유효하며, 다른 네트워크의 장치와 직접 통신할 수 없습니다.

2. **확장성 부족**: MAC 주소는 물리적으로 할당되는 주소로, 네트워크 토폴로지에 따라 구조화되어 있지 않습니다. 이로 인해 대규모 네트워크에서 효율적인 라우팅이 어렵습니다.

3. **브로드캐스트 도메인 제한**: 브로드캐스트 트래픽은 동일한 네트워크 내 모든 장치에 전달되므로, 네트워크 규모가 커질수록 성능 저하가 발생합니다.

4. **논리적 주소 체계 부재**: 물리적 주소(MAC)만으로는 네트워크의 논리적 구조를 표현하기 어렵습니다.

이러한 한계를 극복하기 위해 네트워크 계층이 필요하게 되었으며, 인터넷 프로토콜(IP)이 이 역할을 담당합니다.

### 인터넷 프로토콜

인터넷 프로토콜(Internet Protocol, IP)은 네트워크 계층(OSI 모델의 3계층)에서 동작하는 프로토콜로, 서로 다른 네트워크 간의 데이터 전송을 가능하게 합니다. IP는 TCP/IP 프로토콜 스위트의 핵심 구성 요소로, 인터넷의 기반이 되는 프로토콜입니다.

#### IP 주소 형태

IP 주소는 네트워크 상의 장치를 식별하는 논리적 주소입니다. 현재 널리 사용되는 IP 주소 체계는 다음과 같습니다:

1. **IPv4(Internet Protocol version 4)**: 32비트 주소 체계로, 8비트씩 4개의 옥텟(octet)으로 구성되며 각 옥텟은 점(.)으로 구분됩니다. 예: 192.168.1.1
   - 총 2^32개(약 43억 개)의 주소 공간을 제공합니다.
   - 주소 고갈 문제로 인해 NAT(Network Address Translation)와 같은 기술이 도입되었습니다.

2. **IPv6(Internet Protocol version 6)**: 128비트 주소 체계로, 16비트씩 8개의 블록으로 구성되며 각 블록은 콜론(:)으로 구분됩니다. 예: 2001:0db8:85a3:0000:0000:8a2e:0370:7334
   - 총 2^128개(약 3.4 × 10^38개)의 주소 공간을 제공합니다.
   - 주소 표기 시 연속된 0은 생략 가능합니다. 예: 2001:0db8:85a3::8a2e:0370:7334

#### IP의 기능

IP는 다음과 같은 주요 기능을 제공합니다:

1. **패킷 라우팅**: 출발지에서 목적지까지 패킷이 전달되는 경로를 결정합니다.

2. **논리적 주소 지정**: IP 주소를 통해 네트워크 상의 장치를 논리적으로 식별합니다.

3. **패킷 단편화와 재조립**: 큰 데이터를 네트워크의 최대 전송 단위(MTU)에 맞게 작은 조각으로 나누고, 목적지에서 다시 조립합니다.

4. **비연결형 서비스**: 패킷마다 독립적으로 처리되며, 연결 설정 없이 데이터를 전송합니다.

5. **최선형 전달(Best-effort delivery)**: 패킷 전달을 보장하지 않으며, 오류 제어나 흐름 제어 기능이 없습니다. 이러한 기능은 상위 계층(전송 계층)에서 제공됩니다.

#### IPv4

IPv4는 현재 가장 널리 사용되는 인터넷 프로토콜 버전입니다. IPv4 패킷의 구조는 다음과 같습니다:

1. **헤더**: 20~60바이트 크기로, 다음과 같은 필드를 포함합니다:
   - **버전(Version)**: IPv4의 경우 4 (4비트)
   - **헤더 길이(IHL, Internet Header Length)**: 헤더의 길이 (4비트)
   - **서비스 유형(ToS, Type of Service)**: 패킷의 우선순위 정보 (8비트)
   - **전체 길이(Total Length)**: 헤더와 데이터를 포함한 패킷의 전체 길이 (16비트)
   - **식별자(Identification)**: 단편화된 패킷을 식별하는 값 (16비트)
   - **플래그(Flags)**: 단편화 관련 제어 비트 (3비트)
   - **단편 오프셋(Fragment Offset)**: 단편의 위치 정보 (13비트)
   - **생존 시간(TTL, Time To Live)**: 패킷이 네트워크에 존재할 수 있는 최대 시간 또는 홉 수 (8비트)
   - **프로토콜(Protocol)**: 상위 계층 프로토콜 식별자 (8비트)
   - **헤더 체크섬(Header Checksum)**: 헤더의 오류 검출을 위한 값 (16비트)
   - **출발지 IP 주소(Source IP Address)**: 패킷을 보낸 호스트의 IP 주소 (32비트)
   - **목적지 IP 주소(Destination IP Address)**: 패킷을 받을 호스트의 IP 주소 (32비트)
   - **옵션(Options)**: 선택적 필드로, 보안, 경로 지정 등의 추가 정보 (가변 길이)
   - **패딩(Padding)**: 헤더 길이를 32비트의 배수로 맞추기 위한 0 비트 (가변 길이)

2. **데이터**: 실제 전송할 데이터(페이로드)가 포함됩니다.

IPv4의 주요 특징:
- **클래스 기반 주소 체계**: 원래 A, B, C, D, E 클래스로 구분되었으나, 현재는 CIDR(Classless Inter-Domain Routing)을 통해 더 유연한 주소 할당이 가능합니다.
- **NAT(Network Address Translation)**: 사설 IP 주소를 공인 IP 주소로 변환하여 주소 부족 문제를 완화합니다.
- **제한된 주소 공간**: 약 43억 개의 주소만 제공하여 현대 인터넷 환경에서 부족합니다.
- **보안 기능 부재**: 기본적인 보안 기능이 없어 IPsec과 같은 추가 프로토콜이 필요합니다.

#### IPv6

IPv6는 IPv4의 한계를 극복하기 위해 개발된 차세대 인터넷 프로토콜입니다. IPv6 패킷의 구조는 다음과 같습니다:

1. **기본 헤더**: 40바이트 고정 크기로, 다음과 같은 필드를 포함합니다:
   - **버전(Version)**: IPv6의 경우 6 (4비트)
   - **트래픽 클래스(Traffic Class)**: QoS 관련 정보 (8비트)
   - **플로우 레이블(Flow Label)**: 특정 트래픽 플로우 식별 (20비트)
   - **페이로드 길이(Payload Length)**: 기본 헤더를 제외한 패킷의 길이 (16비트)
   - **다음 헤더(Next Header)**: 확장 헤더 또는 상위 계층 프로토콜 식별자 (8비트)
   - **홉 제한(Hop Limit)**: IPv4의 TTL과 유사한 기능 (8비트)
   - **출발지 주소(Source Address)**: 패킷을 보낸 호스트의 IPv6 주소 (128비트)
   - **목적지 주소(Destination Address)**: 패킷을 받을 호스트의 IPv6 주소 (128비트)

2. **확장 헤더**: 필요에 따라 추가되는 헤더로, 다음과 같은 종류가 있습니다:
   - **홉별 옵션(Hop-by-Hop Options)**: 경로상의 모든 노드에서 처리해야 하는 옵션
   - **목적지 옵션(Destination Options)**: 최종 목적지에서만 처리되는 옵션
   - **라우팅(Routing)**: 소스 라우팅 정보
   - **단편화(Fragment)**: 패킷 단편화 정보
   - **인증(Authentication)**: 보안 인증 정보
   - **암호화(Encapsulating Security Payload)**: 데이터 암호화 정보

3. **데이터**: 실제 전송할 데이터(페이로드)가 포함됩니다.

IPv6의 주요 특징:
- **확장된 주소 공간**: 128비트 주소로 사실상 무한대의 주소를 제공합니다.
- **간소화된 헤더**: 헤더 구조가 단순화되어 처리 효율성이 향상되었습니다.
- **자동 구성**: 주소 자동 구성(SLAAC) 기능을 통해 네트워크 설정이 간편해졌습니다.
- **내장된 보안**: IPsec이 기본으로 포함되어 보안성이 강화되었습니다.
- **향상된 QoS**: 트래픽 클래스와 플로우 레이블을 통해 QoS 지원이 개선되었습니다.
- **멀티캐스트 지원 강화**: 멀티캐스트 기능이 기본으로 포함되어 있습니다.
- **모바일 IP 지원**: 이동성 지원이 향상되었습니다.

### ARP

ARP(Address Resolution Protocol)는 IP 주소를 MAC 주소로 변환하는 프로토콜입니다. 네트워크 계층(IP)과 데이터 링크 계층(이더넷) 사이의 주소 변환을 담당합니다.

ARP의 동작 과정:
1. **ARP 요청**: 호스트 A가 호스트 B의 IP 주소는 알지만 MAC 주소를 모르는 경우, 호스트 A는 "이 IP 주소를 가진 호스트의 MAC 주소는 무엇인가요?"라는 ARP 요청 메시지를 브로드캐스트합니다.

2. **ARP 응답**: 해당 IP 주소를 가진 호스트 B가 "제 MAC 주소는 이것입니다"라는 ARP 응답 메시지를 호스트 A에게 유니캐스트로 보냅니다.

3. **ARP 캐시**: 호스트 A는 호스트 B의 IP 주소와 MAC 주소 매핑 정보를 ARP 캐시에 저장하여 이후 통신에 사용합니다.

ARP 패킷의 구조:
- **하드웨어 타입(Hardware Type)**: 네트워크 인터페이스 유형 (이더넷의 경우 1)
- **프로토콜 타입(Protocol Type)**: 상위 계층 프로토콜 유형 (IPv4의 경우 0x0800)
- **하드웨어 주소 길이(Hardware Address Length)**: MAC 주소 길이 (이더넷의 경우 6바이트)
- **프로토콜 주소 길이(Protocol Address Length)**: IP 주소 길이 (IPv4의 경우 4바이트)
- **연산 코드(Operation)**: ARP 요청(1) 또는 응답(2)
- **송신자 하드웨어 주소(Sender Hardware Address)**: 송신자의 MAC 주소
- **송신자 프로토콜 주소(Sender Protocol Address)**: 송신자의 IP 주소
- **대상 하드웨어 주소(Target Hardware Address)**: 대상의 MAC 주소 (요청 시에는 0)
- **대상 프로토콜 주소(Target Protocol Address)**: 대상의 IP 주소

ARP의 변형:
- **RARP(Reverse ARP)**: MAC 주소를 IP 주소로 변환하는 프로토콜로, 디스크가 없는 워크스테이션에서 사용되었습니다. 현재는 DHCP로 대체되었습니다.
- **Proxy ARP**: 라우터가 다른 네트워크의 호스트를 대신하여 ARP 요청에 응답하는 기술입니다.
- **Gratuitous ARP**: 요청하지 않은 ARP 응답을 보내는 것으로, IP 주소 충돌 감지나 ARP 캐시 업데이트에 사용됩니다.

### [좀 더 알아보기] IP 단편화를 피하는 방법

IP 단편화(IP Fragmentation)는 큰 IP 패킷을 네트워크의 최대 전송 단위(MTU)에 맞게 작은 조각으로 나누는 과정입니다. 단편화는 다음과 같은 문제를 일으킬 수 있습니다:

- **성능 저하**: 단편화와 재조립 과정에서 추가적인 처리가 필요합니다.
- **패킷 손실 위험 증가**: 하나의 단편이 손실되면 전체 패킷을 재전송해야 합니다.
- **보안 문제**: 일부 보안 장비가 단편화된 패킷을 제대로 검사하지 못할 수 있습니다.

IP 단편화를 피하는 방법:

1. **경로 MTU 발견(PMTUD, Path MTU Discovery)**:
   - 출발지에서 목적지까지의 경로에서 가장 작은 MTU를 찾아 그에 맞게 패킷 크기를 조정합니다.
   - IPv4에서는 DF(Don't Fragment) 플래그를 설정하여 단편화를 금지하고, ICMP "Fragmentation Needed" 메시지를 통해 적절한 MTU를 파악합니다.
   - IPv6에서는 기본적으로 라우터에서 단편화를 수행하지 않고, ICMPv6 "Packet Too Big" 메시지를 통해 MTU 정보를 제공합니다.

2. **MSS(Maximum Segment Size) 조정**:
   - TCP 연결 수립 시 MSS 옵션을 통해 세그먼트 크기를 협상합니다.
   - MSS = MTU - IP 헤더 크기 - TCP 헤더 크기로 설정하여 단편화를 방지합니다.

3. **TCP MTU 블랙홀 감지**:
   - PMTUD가 실패할 경우(예: ICMP 메시지가 차단된 경우) TCP는 타임아웃 후 패킷 크기를 줄여 재전송을 시도합니다.
   - 이를 통해 ICMP 메시지 없이도 적절한 MTU를 찾을 수 있습니다.

4. **점보 프레임(Jumbo Frames) 사용**:
   - 기가비트 이더넷 이상의 환경에서는 MTU를 9000바이트 이상으로 증가시킨 점보 프레임을 사용할 수 있습니다.
   - 이는 대용량 데이터 전송 시 효율성을 높이고 단편화를 줄일 수 있습니다.
   - 단, 경로상의 모든 장비가 점보 프레임을 지원해야 합니다.

5. **애플리케이션 계층에서의 데이터 크기 제한**:
   - 애플리케이션에서 처음부터 작은 크기의 데이터 청크로 분할하여 전송합니다.
   - 이는 단편화 문제를 근본적으로 방지할 수 있지만, 애플리케이션 수준의 변경이 필요합니다.

### 7가지 키워드로 정리하는 핵심 포인트
1. **네트워크 계층**: OSI 모델의 3계층으로, 서로 다른 네트워크 간의 통신을 가능하게 하며 논리적 주소 지정과 라우팅을 담당
2. **IP(인터넷 프로토콜)**: 네트워크 계층의 핵심 프로토콜로, 패킷 기반의 비연결형 서비스를 제공하며 최선형 전달 방식으로 동작
3. **IPv4**: 32비트 주소 체계를 사용하는 인터넷 프로토콜로, 현재 가장 널리 사용되지만 주소 공간 부족 문제가 있음
4. **IPv6**: 128비트 주소 체계를 사용하는 차세대 인터넷 프로토콜로, 확장된 주소 공간과 향상된 기능을 제공
5. **ARP**: IP 주소를 MAC 주소로 변환하는 프로토콜로, 네트워크 계층과 데이터 링크 계층 간의 주소 매핑을 담당
6. **패킷 단편화**: 큰 IP 패킷을 네트워크의 MTU에 맞게 작은 조각으로 나누는 과정으로, 성능 저하와 패킷 손실 위험을 증가시킬 수 있음
7. **경로 MTU 발견**: 출발지에서 목적지까지의 경로에서 가장 작은 MTU를 찾아 패킷 크기를 조정함으로써 단편화를 방지하는 기술

### 확인 문제
1. 다음 중 데이터 링크 계층의 한계로 옳지 않은 것은?
   - [ ] 동일한 네트워크 내의 장치 간 통신만 지원한다
   - [ ] MAC 주소는 네트워크 토폴로지에 따라 구조화되어 있지 않아 대규모 네트워크에서 효율적인 라우팅이 어렵다
   - [ ] 브로드캐스트 트래픽은 동일한 네트워크 내 모든 장치에 전달되어 네트워크 규모가 커질수록 성능 저하가 발생한다
   - [ ] IP 주소를 사용하여 장치를 식별하므로 주소 공간이 제한적이다

2. IPv4와 IPv6의 차이점으로 옳은 것은?
   - [ ] IPv4는 128비트 주소를 사용하고, IPv6는 32비트 주소를 사용한다
   - [ ] IPv4는 내장된 보안 기능을 제공하지만, IPv6는 추가적인 보안 프로토콜이 필요하다
   - [ ] IPv4는 헤더 체크섬 필드가 있지만, IPv6는 이 필드가 제거되었다
   - [ ] IPv4는 자동 주소 구성을 지원하지만, IPv6는 수동 구성만 가능하다

3. ARP의 주요 기능은 무엇인가요?
   - [ ] IP 주소를 도메인 이름으로 변환한다
   - [ ] IP 주소를 MAC 주소로 변환한다
   - [ ] 사설 IP 주소를 공인 IP 주소로 변환한다
   - [ ] IPv4 주소를 IPv6 주소로 변환한다

4. IP 단편화를 피하는 방법으로 옳지 않은 것은?
   - [ ] 경로 MTU 발견(PMTUD)을 사용하여 경로상의 최소 MTU에 맞게 패킷 크기를 조정한다
   - [ ] TCP MSS 옵션을 통해 세그먼트 크기를 MTU에 맞게 협상한다
   - [ ] 점보 프레임을 사용하여 MTU를 증가시킨다
   - [ ] TTL 값을 증가시켜 패킷이 더 많은 홉을 통과할 수 있게 한다

5. 다음 중 IPv6의 특징이 아닌 것은?
   - [ ] 확장된 주소 공간(128비트)을 제공한다
   - [ ] 헤더 구조가 단순화되어 처리 효율성이 향상되었다
   - [ ] 주소 자동 구성(SLAAC) 기능을 통해 네트워크 설정이 간편해졌다
   - [ ] NAT(Network Address Translation)가 기본으로 포함되어 있다

> [정답 및 해설 보기](../answers_and_explanations.md#03-1-lan을-넘어서는-네트워크-계층)